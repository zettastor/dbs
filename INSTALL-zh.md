##  环境需求

### 硬件需求

- 分布式块存储软件(下称“DBS”)部署至少需要 **3个节点**，针对不同的使用场景以及客户环境不同，配置参数有所不同，请参考 [高级配置与定制](docs/configuration-zh.md)。功能展示可以使用虚拟机进行部署，性能测试则应当使用高性能的物理服务器进行部署。
- 在默认配置下，每个节点至少需要 **128GB内存**；最小化验证部署配置下，每个节点需要 **8GB内存**。
- 每个存储节点除了操作系统盘之外，还需要配置至少 **1块1TB空白硬盘**。

> 为了方便说明，下列文档使用 `192.168.1.10`, `192.168.1.11`, `192.168.1.12` 3 个节点来说明部署用例。

### 软件需求

有关操作系统支持列表、安装要求请参考 [安装操作系统](docs/operatingsystem-zh.md) 或者联系对应的工程师获取进一步的信息。
>由于 Linux 的 framebuffer 默认不支持汉字，以下操作需要通过 ssh 终端完成。

## 配置与部署

>**注意**  
下列命令假设您已经具有足够权限，关于使用 `su` 或 `sudo` 等提权操作不再赘述。

### 一、准备安装包

ZettaStor DBS [下载页面](https://zdbs.io/en/download/) 提供的安装包通常包含如下两个文件：  
`Installation-1.0.0-OS-*.tar.gz`  
`pengyun-deploy-1.0.0-OS-*.tar.gz`   

1. 将 `Installation-1.0.0-OS-*.tar.gz` 安装工具放到部署节点（例如集群的第1个节点）的 `~` 目录并解压
```bash
cd ~
ls
Installation-1.0.0-OS-20230103.tar.gz

mkdir -p /opt/deploy && tar -zxf Installation-1.0.0-OS-20230103.tar.gz -C /opt/deploy
# 列出/opt/deploy目录文件
ls /opt/deploy/
Installation
```

2. 将 `pengyun-deploy-1.0.0-OS-*.tar.gz` 放到部署节点（例如集群的第1个节点）的 `/opt/deploy/` 目录
```bash
# 列出/opt/deploy目录文件
ls /opt/deploy/
Installation  pengyun-deploy-1.0.0-OS-20230101.tar.gz
```

### 二、修改配置

执行下列命令，按照提示填写相关配置即可
```bash
cd /opt/deploy/Installation
LANGUAGE=zh_CN ./install.sh
```
1. 配置集群用户名和密码
```
=== (1/17): 配置集群用户名和密码 ===
集群节点用户名: root
集群节点密码: 111111
此配置是否正确且完整?
按 Enter 继续，按 [M] 键修改:
```

2. 配置集群地址  
```
=== (2/17): 配置集群地址 ===
集群节点 IP 地址:
192.168.1.10:192.168.1.11,192.168.1.12
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
IP地址之间使用逗号分隔表示多个独立IP地址，使用冒号分隔表示连续IP地址。  
`192.168.1.10:192.168.1.12` 指 `192.168.1.10`, `192.168.1.11`, `192.168.1.12` 三台服务器。  
`192.168.1.11,192.168.1.12` 指 `192.168.1.11`, `192.168.1.12` 两台服务器。

3. 配置集群主机名前缀
```
=== (3/17): 配置集群主机名 ===
集群节点的主机名前缀: server
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```

4. 配置 NTP 模式  
```
=== (4/17): 配置 NTP 模式 ===
集群节点 NTP 模式: ntpdate
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
时间同步服务器的类型默认选择 `ntpdate`，CentOS 8 或 Redhat 8 请选择 `chrony`

5. 配置 NTP 服务器  
```
=== (5/17): 配置 NTP 服务器 ===
集群节点 NTP 服务器地址:
192.168.1.10
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
此处可以使用集群内的节点自动安装 NTP 服务，也可以使用外部已有的 NTP 服务地址，以确保集群各节点之间时间同步。

6. 配置数据库模式  
```
=== (6/17): 配置数据库模式 ===
集群节点数据库模式: single
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
`single` 模式需要 1 个节点，`pacemaker` 模式需要 2 个节点，`etcd` 模式需要 3 个节点

7. 配置数据库主机  
当数据库集群模式选择 `etcd`、`pacemaker`时需配置，否则自动跳过。

8. 配置数据库从机  
仅当数据库集群模式选择 `pacemaker` 时需配置，否则自动跳过

9. 配置数据库地址  
```
=== (9/17): 配置数据库地址 ===
指定数据库集群节点的 IP 地址范围:
192.168.1.10
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```

10. 配置 HA 服务  
```
=== (10/17): 配置 HA 服务 ===
指定HA服务的IP地址范围：
192.168.1.11,192.168.1.12
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
用于高可用性服务的节点数需≥2

11. 配置存储服务  
```
=== (12/17): 配置存储服务 ===
指定存储服务的 IP 地址范围:
192.168.1.10:192.168.1.12
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
通常为集群的所有节点，**每个节点除了安装操作系统的硬盘外，还需要准备额外的空白磁盘用于存储服务**。

12. 配置 Web 界面
```
=== (12/17): 配置 Web 界面 ===
Web 界面的 IP 地址: 192.168.1.10
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
在部署完成之后，可通过浏览器访问该 IP 地址进入管理界面

13. 是否启用数控分离网络？  
```
=== (13/17): 是否启用数控分离网络？ ===
当前配置：false
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
如果此处选择 `false`，向导会自动跳过步骤16、17
>**数控分离**  
通常情况下，建议 DBS 的控制流和数据流使用不同的网络。控制流对带宽要求不高，但是对链路稳定性要求较高；数据流对网络带宽要求较高，建议使用光纤或者 InfiniBand 网络，以获得更好的传输性能。在生产环境建议数据流和控制流配置冗余链路。

14. 控制网络的网段
```
=== (14/17): 控制网络的网段 ===
控制网络的网段 (如 192.168.1.0/24).
当前配置：192.168.1.0/24
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```

15. 数据网络的网段  
用于存储节点之间内部数据的传输。

16. 用户网络的网段  
用于计算节点和存储节点之间的I/O传输。

17. 你是在物理服务器上部署吗？
```
=== (17/17): 你是在物理服务器上部署吗？ ===
每个物理节点至少需要128GB的内存。最小化验证部署请选择"false"，在这种配置下，每个节点只需要8GB的内存。
当前配置：false
此配置是否正确且完整?
按 Enter 继续，[M] 修改，[P] 返回上一步:
```
如果使用虚拟机如 VMware 进行部署，请选择 `false`

至此，修改配置的操作已经全部完成，您可以按 `Ctrl+C` 键中止安装向导，并参照下一节进行一键式部署。如果继续安装向导，则会进入交互式部署，涉及的10个步骤与下一节所述一致。

### 三、部署服务
1. 部署 DBS，请执行下列命令：
```
cd /opt/deploy/Installation
LANGUAGE=zh_CN ./install.sh --batch
```
2. 部署包括下列 10 个步骤，执行过程无需用户交互。

```
=== (1/10): 设置部署服务器 ===
在当前主机上安装软件包，用于设置部署服务器。

=== (2/10): 检查部署服务器 ===
检查当前主机是否符合部署服务器的要求。

=== (3/10): 检查集群节点 ===
检查集群主机是否符合部署服务器的要求。

=== (4/10): 设置集群节点 ===
在集群节点上安装软件包。

=== (5/10): 安装时间同步服务 ===
在集群节点上安装 ntpdate 或 chrony 服务。

=== (6/10): 时间同步 ===
集群主机时间同步。

=== (7/10): 检查集群状态 ===
检查集群主机的状态。

=== (8/10): 安装数据库服务 ===
安装产品所需的数据库服务 (PostgreSQL)。

=== (9/10): 更新系统配置 ===
更新产品的配置设置。

=== (10/10): 部署块存储 ===
部署位于Installation文件夹的父文件夹下的tar.gz安装包。
```

如果出现错误则会报错退出，请根据屏幕提示（**特别是红字**）具体分析。

>因集群节点数量、硬件配置、磁盘配置等不同，部署时间差异较大，请耐心等待，不要中断部署操作。

3. 部署完成之后，可通过浏览器访问 DBS Web 界面，访问地址为 `http://192.168.1.10:8080` 其中 `192.168.1.10` 为修改配置第13步中配置的“Web 界面的 IP 地址”。有关 DBS 的操作与使用，请参考 [用户手册](docs/manual-zh.md)。

### 四、清除部署
如果需要清除已经部署的 DBS，执行下列命令：
```bash
cd /opt/deploy/Installation
perl product_block_storage_operation.pl -o wipeout
```
